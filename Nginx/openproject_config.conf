 HTTP â†’ HTTPS
server {
  listen 80;
  listen [::]:80;
  server_name openproject.mayer-it.net;
  return 301 https://openproject.mayer-it.net$request_uri;
}

# WebSocket helper
map $http_upgrade $connection_upgrade { default upgrade; '' close; }

server {
  listen 443 ssl;
  listen [::]:443 ssl;
  server_name openproject.mayer-it.net;

  ssl_certificate     /etc/ssl/mayer-it/wildcard.mayer-it.net.fullchain.pem;
  ssl_certificate_key /etc/ssl/mayer-it/wildcard.mayer-it.net.key.pem;

  client_max_body_size 200m;
  proxy_buffering off;
  proxy_request_buffering off;
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
  proxy_connect_timeout 60s;

  add_header Referrer-Policy "no-referrer-when-downgrade" always;
  add_header X-Content-Type-Options nosniff always;
  add_header X-Frame-Options DENY always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Cache-Control "no-transform";

# ---------- serve static assets directly ----------
  # Assets (CSS/JS/images compiled by OP)
  location ^~ /assets/ {
    alias /opt/openproject/public/assets/;
    access_log off;
    expires 1y;
    add_header Cache-Control "public";
    try_files $uri =404;
  }

  # Webpacker/Vite packs (JS bundles)
  location ^~ /packs/ {
    alias /opt/openproject/public/packs/;
    access_log off;
    expires 1y;
    add_header Cache-Control "public";
    try_files $uri =404;
  }

  # Syntax highlighting CSS
  location ^~ /highlighting/ {
    alias /opt/openproject/public/highlighting/;
    access_log off;
    expires 1y;
    add_header Cache-Control "public";
    try_files $uri =404;
  }

  # Favicon / robots (optional)
  location = /favicon.ico { alias /opt/openproject/public/favicon.ico; access_log off; }
  location = /robots.txt  { alias /opt/openproject/public/robots.txt;  access_log off; }

    location / {
        proxy_pass         http://127.0.0.1:6000;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Host $host:$server_port;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   X-Forwarded-Server $host:$server_port;
        proxy_read_timeout  1200s;

        client_max_body_size 0;
    }
}
